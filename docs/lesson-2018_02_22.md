# Cours du 22/02/2018

## Requête préparée

Le code ci-dessous va permettre de récuperer la liste des 5 premiers enregistrements de la table `clients` avec l'utilisation d'une requête préparée en PDO.

```php
$limit = 5;
$offset = 0;
$requeteClient = "select * from clients limit :limit offset :offset";

$clientSth = $connexion->prepare($requeteClient);

$clientSth->bindParam('limit', $limit, \PDO::PARAM_INT);
$clientSth->bindParam('offset', $offset, \PDO::PARAM_INT);

$clientSth->execute();
```
la variable `$requeteClient` va contenir la requête préparée, vous pouvez y ajouter ou pas des `noms` (:nom, :limit et :offset) ou des `marqueurs` (?).

Ci-dessous un exemple avec des marqueurs

```php
$requeteClient = "select * from clients limit ? offset ?";

$clientSth = $connexion->prepare($requeteClient);

$clientSth->bindParam(1, $limit, \PDO::PARAM_INT);
$clientSth->bindParam(2, $offset, \PDO::PARAM_INT);
```

### Prepare
Prépare la requête.
```php
$requeteClient = "select * from clients limit ? offset ?";
$clientSth = $connexion->prepare($requeteClient);
```

- [Doc prepare](http://php.net/manual/fr/pdo.prepare.php)

### BindParam et bindValue
**bindParam** va lier un paramètre à un nom de variable spécifique et **binValue** associe une valeur à un paramètre

```php
//liaison avec une variable
$clientSth->bindParam('limit', $limit, \PDO::PARAM_INT);
//liaison avec une valeur
$clientSth->bindValue('limit', 5, \PDO::PARAM_INT);
```

 - [Doc bindParam](http://php.net/manual/fr/pdostatement.bindparam.php)
 - [Doc bindValue](http://php.net/manual/fr/pdostatement.bindvalue.php)

### Execute
Execute la requête préparée, retourne un boolean faux ou vrai en cas de succès. Vous pouvez passer en paramètre des valeurs qui seront associées à la requête (elle seront au format **string**)

- [Docs execute](http://php.net/manual/fr/pdostatement.execute.php)

## Gestion de la pagination

Pour gérer la pagination, il faut récupérer le nombre total d'enregistrements de la table.

```php
$requeteNbClients = "select count(*) as nbre from clients";
$nbClientSth = $connexion->prepare($requeteNbClients);
$nbClientSth->execute();
$nbClient = $nbClientSth->fetch(PDO::FETCH_COLUMN);
```
Dès que nous récupérons ce nombre (`$nbClient`), il faut définir le nombre d'enregistrements que l'on souhaite afficher par page

```php
$limit = 5;
```
Ces deux informations vont nous permettre de calculer le nombre de pages que nous allons avoir au total (ceil = arrondit au nombre supérieur)

```php
$nbPages = ceil($nbClient/$limit);
```

Pour finir, il faut indiquer la page sur laquelle on se trouve ce qui va nous permettre de calculer le décalage
```php
$page = 1;
$offset = ($page-1)*$limit ;
```


## group_concat
Permet de regrouper des valeurs non nulles d'un groupe.

```sql
select country, group_concat(ci.city separator ', ') as city from country as co
join city as ci on ci.country_id = co.country_id
group by country;
```

http://sql.sh/fonctions/group_concat

## Les plus hors scope du cours

### Modification de types
Vous pouvez modifier le type d'une variable en la préfixant entre parenthèse du type désiré.
```php
$foo = 10;               // $foo est un entier
$bar = (boolean) $foo;   // $bar est un booléen
```

http://php.net/manual/fr/language.types.type-juggling.php


### yoda style
On écrit la constante à la gauche de l'opérateur de comparaison, et le nom de la variable dont la valeur est comparée à la constante à la droite.

```if (true == $test) { ... }```

https://fr.wikipedia.org/wiki/Condition_Yoda

### Logiciel GIT

- [sourcetree](https://www.sourcetreeapp.com/)
- [gitkraken](https://www.gitkraken.com/)
