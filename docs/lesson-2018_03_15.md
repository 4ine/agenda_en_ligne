# Cours du 15/03/2018

## Requête préparée

### Template de requête sql

Au lieu de créer une variable pour stocker le template de requête sql, vous pouvez directement passer votre template à la méthode **prepare()**

Exemple sans la création d'une variable
```php
 $clientSth = $connexion->prepare("insert into clients (nom, prenom, genre, date_de_naissance, email, telephone)
 values (:nom, :prenom, :genre, :date_de_naissance, :email, :telephone)");
}
```
Exemple avec la création d'une variable
```php
$requeteClient = "insert into clients (nom, prenom, genre, date_de_naissance, email, telephone)
values (:nom, :prenom, :genre, :date_de_naissance, :email, :telephone)";

 $clientSth = $connexion->prepare($requeteClient);
}
```


### Les différentes façon de lier les paramètres aux noms

Vous pouvez lier vos données aux noms avec les méthodes **bindParam** ou **bindValue**

Exemple

```sql
$requeteClient = "insert into clients (nom, prenom, genre, date_de_naissance, email, telephone)
values (:nom, :prenom, :genre, :date_de_naissance, :email, :telephone)";

 $clientSth = $connexion->prepare($requeteClient);

 $clientSt->binParam('nom', $_POST['nom']);
 $clientSt->binParam('prenom', $_POST['prenom']);
 $clientSt->binParam('genre', $_POST['genre']);
 $clientSt->binParam('date_de_naissance', $_POST['date_de_naissance']);
 $clientSt->binParam('email', $_POST['email']);
 $clientSt->binParam('telephone', $_POST['telephone']);

 $clientSt->execute();
```

Ou vous pouvez passer vos données directement dans la méthode **execute()**. Attention toutes les valeurs seront traitées comme des constantes **PDO::PARAM_STR**(à ne pas utiliser pour des ***limit*** ou ***offset***)

```sql
$requeteClient = "insert into clients (nom, prenom, genre, date_de_naissance, email, telephone)
values (:nom, :prenom, :genre, :date_de_naissance, :email, :telephone)";

 $clientSth = $connexion->prepare($requeteClient);

 $clientSth->execute([
	 'nom' => $_POST['nom'],
	 'prenom' => $_POST['prenom'],
	 'genre' => $_POST['genre'],
	 'date_de_naissance' => $_POST['nomdate_de_naissance'],
	 'email' => $_POST['email'],
	 'telephone' => $_POST['telephone'],
 ]);
```

### Récupérer les lignes d'un jeu d'enregistrements

Lorsque vous faites un **select**, après avoir executé votre requête, vous voudriez récupérer un jeu d'enregistrements, pour cela vous avez les méthodes **fetch** ou **fetchAll**

#### fetch

La méthode fetch permet de récupérer une ligne d'enregistrement

[Doc fetch](http://php.net/manual/fr/pdostatement.fetch.php)

#### fetchAll

La méthode fetchAll permet de récupérer un tableau contenant toutes les lignes d'un jeu d'enregistrements

[Doc fetchAll](http://php.net/manual/fr/pdostatement.fetchall.php)



### Récupérer les erreurs
Si vous avez un souci lors de l'execution de votre requête, vous pouvez utiliser la méthode **errorInfo()** juste après la méthode **execute()**, elle va vous permettre de récupérer l'erreur sql.

```php
$clientSth->execute();

$error = $clientSth->errorInfo();
print_r($error);
exit;
```

[Doc errorInfo](http://php.net/manual/fr/pdo.errorinfo.php)

### Méthode RowCount
La méthode **rowCount()** permet de récupérer le nombre de lignes affectées par le dernier appel à la méthode **execute()**, on peut l'utiliser pour vérifier si une insertion ou un mise à jour a bien été effectuée.

[Doc rowCount](http://php.net/manual/fr/pdostatement.rowcount.php)

## Les plus hors scope du cours

### Mettre à jour les champs d'un formulaire pour l'édition

Lors que vous êtes en mode édition d'un client, il faut au préalable récupérer le client en base et stocker ses information dans une variable **$client**, ensuite on va alimenter le formulaire avec ces informations.

#### Champ texte

```php
<div class="form-group row">
  <label for="nom" class="col-2 col-form-label">Nom</label>
  <div class="col-10">
    <input class="form-control" type="text" name="nom" value="<?= $client['nom'] ?? '' ?>" id="nom">
  </div>
</div>
```

### Champ select

```php
<div class="form-group row">
  <label for="genre" class="col-2 col-form-label">Genre</label>
  <div class="col-10">
    <select name="genre" class="form-control" id="genre">
         <option value="0">N/D</option>
         <?php foreach($arrayGenre as $cle => $genre): ?>
           <option <?= (isset($client) && $cle == $client['genre'] ? 'selected' : '') ?> value='<?php echo $cle ?>'><?php echo $genre ?></option>
         <?php endforeach; ?>
    </select>
  </div>
</div>
```
